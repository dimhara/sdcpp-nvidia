# -------------------------------------------------------------------
# STAGE 1: BUILDER
# -------------------------------------------------------------------
FROM nvidia/cuda:12.2.0-devel-ubuntu22.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Install build tools
RUN apt-get update && apt-get install -y \
    git cmake build-essential libcurl4-openssl-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
RUN git clone --recursive https://github.com/leejet/stable-diffusion.cpp

WORKDIR /app/stable-diffusion.cpp
RUN mkdir build
WORKDIR /app/stable-diffusion.cpp/build

# 75 = RTX 20-series (Turing)
# 86 = RTX 30-series / A4000 / A5000 / A6000 (Ampere)
# 89 = RTX 40-series / RTX 6000 Ada / RTX 4000 SFF Ada (Ada Lovelace)
# SD_CUBLAS=ON
RUN cmake .. -DSD_CUDA=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_CUDA_ARCHITECTURES="75;86;89" && \
    cmake --build . --config Release -- -j$(nproc)

# -------------------------------------------------------------------
# STAGE 2: RUNTIME (Serverless Worker)
# -------------------------------------------------------------------
FROM nvidia/cuda:12.2.0-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# 1. Install Runtime Deps, Python, RunPod SDK, HF Hub
RUN apt-get update && apt-get install -y \
    python3 python3-pip wget libgomp1 libcurl4 \
    && rm -rf /var/lib/apt/lists/*

RUN pip3 install -U "huggingface_hub"

# 2. Prepare Directories
WORKDIR /
RUN mkdir -p /models

# 3. BAKING IN MODELS
# We set the env var to enable fast transfers during build
ENV HF_HUB_ENABLE_HF_TRANSFER=1

# Download Diffusion Model
RUN hf download leejet/Z-Image-Turbo-GGUF z_image_turbo-Q4_K.gguf \
    --local-dir /models
    
# Download LLM (Qwen)
RUN hf download unsloth/Qwen3-4B-Instruct-2507-GGUF Qwen3-4B-Instruct-2507-Q4_K_M.gguf \
    --local-dir /models

# Download VAE (Handling the subdirectory structure)
RUN hf download Comfy-Org/z_image_turbo split_files/vae/ae.safetensors \
    --local-dir /models && \
    mv /models/split_files/vae/ae.safetensors /models/ae.safetensors && \
    rm -rf /models/split_files

# 4. Copy the binary from Builder
COPY --from=builder /app/stable-diffusion.cpp/build/bin/sd /usr/local/bin/sd

# 5. Copy the Python Handler
COPY rp_handler.py /rp_handler.py

# 6. Start the Handler
CMD ["python3", "-u", "/rp_handler.py"]
